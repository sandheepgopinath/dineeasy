<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for sortable table headers */
        .sortable-header {
            cursor: pointer;
            position: relative;
        }
        .sortable-header::after, .sortable-header::before {
            content: '';
            display: block;
            position: absolute;
            right: 10px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.3;
        }
        .sortable-header::before {
            border-bottom: 5px solid #6b7280;
            top: 50%;
            margin-top: -7px;
        }
        .sortable-header::after {
            border-top: 5px solid #6b7280;
            top: 50%;
            margin-top: 1px;
        }
        .sortable-header.asc::before {
            opacity: 1;
        }
        .sortable-header.desc::after {
            opacity: 1;
        }
        /* Custom dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-chevron-down'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Table Styles */
        @media (max-width: 767px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody, .responsive-table tr, .responsive-table td {
                display: block;
                width: 100%;
            }
            .responsive-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
            }
            .responsive-table td {
                padding-left: 50%;
                position: relative;
                text-align: right;
                border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: 45%;
                padding-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: #111827;
            }
        }
        
        /* Filter button active state */
        .filter-btn.active {
            background-color: #111827;
            color: #ffffff;
            border-color: #111827;
        }

        .glass-button-blue {
            background: rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e3a8a;
        }
        .glass-button-blue:hover {
            background: rgba(59, 130, 246, 0.3);
        }

         .glass-button-red {
            background: rgba(239, 68, 68, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #b91c1c;
        }
        .glass-button-red:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .glass-button-gray {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
         .glass-button-gray:hover {
            background: rgba(255, 255, 255, 0.7);
        }


    </style>
</head>
<body class="bg-gray-50 text-sm">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-gray-800">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md">
            <div class="text-center">
                 <div class="flex items-center justify-center text-2xl font-bold text-gray-800 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                    <span>DineEase</span>
                </div>
                <p class="text-gray-500">Welcome back! Please login to your account.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="you@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="••••••••">
                </div>
                <div>
                    <button id="login-button" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Main Dashboard -->
    <div id="dashboard-screen" class="h-screen hidden">
        <!-- Sidebar -->
        <aside class="w-56 bg-gray-800 text-white flex-shrink-0 hidden md:flex md:flex-col">
            <div class="h-16 flex items-center justify-center text-xl font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                <span>DineEase</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="dashboard-content">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="menu-content">
                    <i data-lucide="menu" class="w-5 h-5 mr-3"></i>
                    Menu
                </a>
                <a href="#" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-md" data-target="restaurant-management-content">
                    <i data-lucide="store" class="w-5 h-5 mr-3"></i>
                    Restaurants
                </a>
                 <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="user-management-content">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    User Management
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="order-food-content">
                    <i data-lucide="shopping-cart" class="w-5 h-5 mr-3"></i>
                    Order Food
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between h-auto min-h-[4rem] px-4 md:px-8 py-2">
                    <div class="flex items-center w-full md:w-auto">
                         <button id="menu-button" class="md:hidden mr-4 text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 id="header-title" class="text-base md:text-lg font-semibold text-gray-800">Restaurant Management</h1>
                    </div>
                    <div class="flex items-center space-x-3 w-full md:w-auto justify-between mt-2 md:mt-0">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="searchInput" placeholder="Search" class="pl-9 pr-4 py-1.5 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs">
                        </div>
                        
                        <!-- Action Buttons Container -->
                        <div id="restaurant-actions" class="items-center space-x-3 hidden">
                            <button id="add-restaurant-btn" class="glass-button-blue px-3 py-1.5 rounded-md text-xs">Add Restaurant</button>
                        </div>
                         <div id="menu-actions" class="items-center space-x-2 hidden">
                             <select id="menuRestaurantFilter" class="block w-full pl-3 pr-10 py-1.5 text-xs border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="">Select Restaurant</option>
                            </select>
                            <button id="add-menu-item-btn" class="glass-button-blue px-3 py-1.5 rounded-md text-xs whitespace-nowrap">Add Item</button>
                            <button id="delete-selected-menu-items-btn" class="glass-button-red px-3 py-1.5 rounded-md text-xs whitespace-nowrap hidden">Delete Selected</button>
                        </div>
                        <div id="user-actions" class="items-center space-x-2 hidden">
                             <select id="restaurantFilter" class="block w-full pl-3 pr-10 py-1.5 text-xs border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="all">All Restaurants</option>
                            </select>
                            <button id="add-user-btn" class="glass-button-blue px-3 py-1.5 rounded-md text-xs whitespace-nowrap">Add User</button>
                             <button id="delete-selected-users-btn" class="glass-button-red px-3 py-1.5 rounded-md text-xs whitespace-nowrap hidden">Delete Selected</button>
                        </div>
                         <div id="order-food-actions" class="items-center space-x-2 hidden">
                             <select id="order-restaurant-filter" class="block w-full pl-3 pr-10 py-1.5 text-xs border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="">Select Restaurant</option>
                            </select>
                        </div>
                        
                         <div class="relative">
                           <button id="user-avatar-btn" class="w-9 h-9 bg-blue-500 text-white rounded-full flex items-center justify-center text-base font-semibold">U</button>
                           <div id="logout-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                               <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                           </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mobile Sidebar -->
            <div id="mobile-menu" class="md:hidden bg-gray-800 text-white fixed inset-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                     <div class="h-16 flex items-center text-xl font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                        <span>DineEase</span>
                    </div>
                    <button id="close-menu-button" class="text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav id="mobile-nav" class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="dashboard-content">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="menu-content">
                        <i data-lucide="menu" class="w-5 h-5 mr-3"></i>
                        Menu
                    </a>
                    <a href="#" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-md" data-target="restaurant-management-content">
                        <i data-lucide="store" class="w-5 h-5 mr-3"></i>
                        Restaurants
                    </a>
                     <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="user-management-content">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                        User Management
                    </a>
                    <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="order-food-content">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-3"></i>
                        Order Food
                    </a>
                </nav>
            </div>

             <!-- Dashboard Content -->
            <main id="dashboard-content" class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-8 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total Restaurants</h3>
                        <p id="total-restaurants" class="mt-2 text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total Users</h3>
                        <p id="total-users" class="mt-2 text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total Menu Items</h3>
                        <p id="total-menu-items" class="mt-2 text-3xl font-bold text-gray-900">0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Menu Items per Restaurant</h3>
                    <div class="h-96">
                       <canvas id="menu-items-chart"></canvas>
                    </div>
                </div>
            </main>

            <!-- Restaurant Table -->
            <main id="restaurant-management-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8">
                <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="restaurantTable" class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="name">Name</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="owner">Owner</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="contact">Contact</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="address">Address</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="onboarding">Onboarding</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="plan">Plan</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="payment">Payment</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- Menu Table -->
            <main id="menu-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8 hidden">
                 <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="menuTable" class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-4 text-center"><input type="checkbox" id="select-all-menu-items" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"></th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="name">Name</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="restaurantId">Restaurant</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="category">Category</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="price">Price</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="prepTime">Time to Prep.</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- User Management Table -->
            <main id="user-management-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8 hidden">
                <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="userTable" class="min-w-full divide-y divide-gray-200">
                           <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-4 text-center"><input type="checkbox" id="select-all-users" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"></th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="name">Name</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="email">Email</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="restaurants">Restaurant</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="status">Status</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="role">Role</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="lastLogin">Last log in</th>
                                    <th scope="col" class="px-2 py-1 md:px-4 md:py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>
            
             <!-- Order Food Page -->
            <main id="order-food-content" class="flex-1 overflow-y-auto bg-white p-4 md:p-8 hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">Order Food</h2>
                        <p class="text-gray-500">Filter dishes based on your preferences</p>
                    </div>

                    <div id="interactive-filters" class="p-4 border rounded-lg bg-white mb-8 shadow-sm">
                        <!-- Filters will be generated by JS -->
                    </div>

                    <h3 id="all-items-count" class="text-xl font-bold text-gray-800 mb-4">All Items</h3>
                    <div id="interactive-menu-items" class="space-y-6">
                        <!-- Menu items will be generated by JS -->
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Cart Icon -->
        <button id="cart-button" class="fixed bottom-28 right-8 w-16 h-16 bg-blue-500/20 backdrop-blur-lg text-blue-800 border border-blue-500/30 rounded-full flex items-center justify-center shadow-lg hidden z-40">
            <i data-lucide="shopping-cart" class="w-8 h-8"></i>
            <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">0</span>
        </button>

        <!-- Order Status Footer -->
        <div id="order-status-footer" class="fixed bottom-0 left-0 right-0 p-4 hidden z-40">
            <div class="max-w-4xl mx-auto bg-white/60 backdrop-blur-xl rounded-lg shadow-lg flex items-center justify-between p-4 border border-white/30">
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-600">Order Status:</p>
                    <p id="order-status-text" class="font-bold text-gray-900">Order Received</p>
                </div>
                 <button id="edit-order-btn" class="glass-button-blue text-xs font-semibold px-4 py-2 rounded-md">Edit Order</button>
            </div>
        </div>

    </div>

    <!-- Cart Panel -->
    <div id="cart-panel" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white/60 backdrop-blur-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-white/30">
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="text-lg font-semibold">Your Order</h2>
            <button id="close-cart-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div id="cart-items-container" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Cart items will be generated by JS -->
        </div>
        <div class="p-4 border-t">
            <div>
                <label for="chef-notes" class="block text-sm font-medium text-gray-700">Notes for the Chef (Optional)</label>
                <textarea id="chef-notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
            </div>
            <div class="flex justify-between items-center mt-4 text-lg font-bold">
                <span>Total:</span>
                <span id="cart-total">₹0.00</span>
            </div>
            <button id="confirm-order-btn" class="mt-4 w-full glass-button-blue font-semibold py-3 rounded-md">Confirm Order</button>
        </div>
    </div>


    <!-- Add/Edit Restaurant Modal -->
    <div id="restaurant-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-lg font-semibold">Add Restaurant</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="restaurant-form" class="space-y-4">
                <input type="hidden" id="res-id">
                <div>
                    <label for="res-name" class="block text-xs font-medium text-gray-700">Name</label>
                    <input type="text" id="res-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="relative">
                    <label for="res-owner-search" class="block text-xs font-medium text-gray-700">Owner</label>
                    <input type="text" id="res-owner-search" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" autocomplete="off">
                    <div id="owner-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden"></div>
                </div>
                <div>
                    <label for="res-contact" class="block text-xs font-medium text-gray-700">Contact</label>
                    <input type="text" id="res-contact" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="res-address" class="block text-xs font-medium text-gray-700">Address</label>
                    <input type="text" id="res-address" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="res-onboarding" class="block text-xs font-medium text-gray-700">Onboarding Date</label>
                        <input type="date" id="res-onboarding" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="res-plan" class="block text-xs font-medium text-gray-700">Plan Type</label>
                        <select id="res-plan" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Basic</option>
                            <option>Premium</option>
                        </select>
                    </div>
                </div>
                 <div>
                    <label for="res-payment" class="block text-xs font-medium text-gray-700">Last Payment (₹)</label>
                    <input type="number" step="0.01" id="res-payment" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-modal-btn" class="glass-button-gray px-4 py-2 text-gray-800 rounded-md">Cancel</button>
                    <button type="submit" class="glass-button-blue px-4 py-2 rounded-md">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="user-modal-title" class="text-lg font-semibold">Add User</h3>
                <button id="close-user-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="user-form" class="space-y-4">
                 <input type="hidden" id="user-id">
                <div>
                    <label for="user-name" class="block text-xs font-medium text-gray-700">Name</label>
                    <input type="text" id="user-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="user-email" class="block text-xs font-medium text-gray-700">Email</label>
                    <input type="email" id="user-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div>
                    <label for="user-password" class="block text-xs font-medium text-gray-700">Password</label>
                    <input type="password" id="user-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <!-- Multi-select restaurant dropdown -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700">Restaurants</label>
                    <div class="mt-1 flex flex-wrap gap-2 p-2 border border-gray-300 rounded-md" id="multi-select-container">
                        <input type="text" id="restaurant-search-input" class="flex-grow focus:outline-none" placeholder="Select restaurants...">
                    </div>
                    <div id="restaurant-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="user-status" class="block text-xs font-medium text-gray-700">Status</label>
                        <select id="user-status" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                    <div>
                        <label for="user-role" class="block text-xs font-medium text-gray-700">Role</label>
                        <select id="user-role" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>User</option>
                            <option>Admin</option>
                            <option>Super Admin</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-user-modal-btn" class="glass-button-gray px-4 py-2 text-gray-800 rounded-md">Cancel</button>
                    <button type="submit" class="glass-button-blue px-4 py-2 rounded-md">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menu-item-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="menu-item-modal-title" class="text-lg font-semibold">Add Menu Item</h3>
                <button id="close-menu-item-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="menu-item-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <input type="hidden" id="menu-item-id">
                <input type="hidden" id="menu-item-restaurant-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div>
                            <label for="item-name" class="block text-xs font-medium text-gray-700">Name <span class="text-red-500">*</span></label>
                            <input type="text" id="item-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="item-description" class="block text-xs font-medium text-gray-700">Description</label>
                            </div>
                            <textarea id="item-description" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                             <button type="button" id="generate-description-btn" class="mt-2 flex items-center justify-center gap-2 text-xs text-white px-3 py-1.5 rounded-md bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Generate with AI
                            </button>
                        </div>
                         <div>
                            <label for="item-category" class="block text-xs font-medium text-gray-700">Category <span class="text-red-500">*</span></label>
                            <select id="item-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>Starter</option>
                                <option>Main Course</option>
                                <option>Dessert</option>
                                <option>Beverage</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-cuisine" class="block text-xs font-medium text-gray-700">Cuisine</label>
                            <select id="item-cuisine" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>American</option>
                                <option>Italian</option>
                                <option>Mexican</option>
                                <option>Japanese</option>
                                <option>Chinese</option>
                                <option>Indian</option>
                                <option>Thai</option>
                                <option>French</option>
                                <option>Spanish</option>
                                <option>Greek</option>
                                <option>Mediterranean</option>
                                <option>Lebanese</option>
                                <option>Vietnamese</option>
                                <option>Korean</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-taste" class="block text-xs font-medium text-gray-700">Taste</label>
                            <select id="item-taste" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>Sweet</option>
                                <option>Creamy</option>
                                <option>Mild Spicy</option>
                                <option>Medium Spicy</option>
                                <option>Super Spicy</option>
                            </select>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700">Image</label>
                            <div id="image-preview-container" class="mt-1 h-40 w-full bg-gray-100 rounded flex items-center justify-center border-2 border-dashed">
                                <img id="item-image-preview" src="" class="max-h-full max-w-full hidden object-contain">
                                <div id="image-loader" class="loader hidden"></div>
                                <span id="image-placeholder" class="text-gray-400 text-xs">Image Preview</span>
                            </div>
                             <input type="file" id="item-image-upload" class="hidden" accept="image/*">
                             <input type="hidden" id="item-image-url">
                            <div class="flex gap-2 mt-2">
                                <button type="button" id="upload-image-btn" class="flex-1 text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-md hover:bg-gray-50">Upload</button>
                                <button type="button" id="generate-image-btn" class="flex-1 flex items-center justify-center gap-2 text-xs text-white px-3 py-1.5 rounded-md bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i> Generate
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="item-price" class="block text-xs font-medium text-gray-700">Price (₹) <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" id="item-price" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="item-prep-time" class="block text-xs font-medium text-gray-700">Time to Preparation (mins) <span class="text-red-500">*</span></label>
                            <input type="number" id="item-prep-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-700">Portion Size</label>
                             <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Mini"> <span class="ml-2">Mini</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Small"> <span class="ml-2">Small</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Medium"> <span class="ml-2">Medium</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Large"> <span class="ml-2">Large</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Extra Large"> <span class="ml-2">Extra Large</span></label>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-menu-item-modal-btn" class="glass-button-gray px-4 py-2 text-gray-800 rounded-md">Cancel</button>
                    <button type="submit" class="glass-button-blue px-4 py-2 rounded-md flex items-center justify-center w-24">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-semibold">Confirm Deletion</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mt-2 mb-4">Are you sure?</p>
            <div id="confirm-input-container" class="hidden">
                 <label for="confirm-input" class="block text-xs font-medium text-gray-700">Please type "Delete" to confirm.</label>
                 <input type="text" id="confirm-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
            </div>
            <div class="flex justify-end pt-4 space-x-2 mt-4">
                <button type="button" id="cancel-confirm-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="button" id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-red-300">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, query, where, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // --- FIREBASE CONFIG ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyCBGMJzHbwD3Y95fwRKVgdYU2KBQ7oDYHQ",
        authDomain: "dineeasy-8176e.firebaseapp.com",
        projectId: "dineeasy-8176e",
        storageBucket: "dineeasy-8176e.firebasestorage.app",
        messagingSenderId: "811985378716",
        appId: "1:811985378716:web:26c599db464c67a537bc59",
        measurementId: "G-0F0ERHYX32"
        };

        // --- GEMINI API KEY ---
        // IMPORTANT: Replace with your actual Gemini API Key
        // Make sure to restrict this key to your website's domain in the Google Cloud Console.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY";


        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DATA STORE ---
        let restaurantData = [];
        let userData = [];
        let menuData = [];
        let currentUserProfile = null;
        let unsubscribeListeners = [];
        let fileToUpload = null;
        let cart = {};
        let currentActiveOrder = null;
        let currentOrderUnsubscribe = null;

        // --- ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const menuButton = document.getElementById('menu-button');
        const closeMenuButton = document.getElementById('close-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const searchInput = document.getElementById('searchInput');
        const restaurantTableBody = document.querySelector('#restaurantTable tbody');
        const menuTableBody = document.querySelector('#menuTable tbody');
        const userTableBody = document.querySelector('#userTable tbody');
        const navLinks = document.querySelectorAll('#sidebar-nav a, #mobile-nav a');
        const contentSections = document.querySelectorAll('main');
        const headerTitle = document.getElementById('header-title');
        const restaurantActions = document.getElementById('restaurant-actions');
        const menuActions = document.getElementById('menu-actions');
        const userActions = document.getElementById('user-actions');
        const restaurantFilter = document.getElementById('restaurantFilter');
        const menuRestaurantFilter = document.getElementById('menuRestaurantFilter');
        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const logoutDropdown = document.getElementById('logout-dropdown');
        const logoutBtn = document.getElementById('logout-btn');
        let currentView = 'restaurant-management-content';

        // Cart Elements
        const cartButton = document.getElementById('cart-button');
        const cartCountBadge = document.getElementById('cart-count-badge');
        const cartPanel = document.getElementById('cart-panel');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalEl = document.getElementById('cart-total');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const interactiveMenuItemsContainer = document.getElementById('interactive-menu-items');
        
        // Order Status Footer Elements
        const orderStatusFooter = document.getElementById('order-status-footer');
        const orderStatusText = document.getElementById('order-status-text');
        const editOrderBtn = document.getElementById('edit-order-btn');


        // Restaurant Modal elements
        const restaurantModal = document.getElementById('restaurant-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const restaurantForm = document.getElementById('restaurant-form');
        const addRestaurantBtn = document.getElementById('add-restaurant-btn');
        const ownerSearchInput = document.getElementById('res-owner-search');
        const ownerDropdown = document.getElementById('owner-dropdown');
        
        // User Modal elements
        const userModal = document.getElementById('user-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const closeUserModalBtn = document.getElementById('close-user-modal-btn');
        const cancelUserModalBtn = document.getElementById('cancel-user-modal-btn');
        const userForm = document.getElementById('user-form');
        const addUserBtn = document.getElementById('add-user-btn');
        const multiSelectContainer = document.getElementById('multi-select-container');
        const restaurantSearchInput = document.getElementById('restaurant-search-input');
        const restaurantDropdown = document.getElementById('restaurant-dropdown');

        // Menu Item Modal elements
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const closeMenuItemModalBtn = document.getElementById('close-menu-item-modal-btn');
        const cancelMenuItemModalBtn = document.getElementById('cancel-menu-item-modal-btn');
        const menuItemForm = document.getElementById('menu-item-form');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const generateDescriptionBtn = document.getElementById('generate-description-btn');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const imagePreview = document.getElementById('item-image-preview');
        const imageLoader = document.getElementById('image-loader');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const imageUploadInput = document.getElementById('item-image-upload');

        // Confirm Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmInputContainer = document.getElementById('confirm-input-container');
        const confirmInput = document.getElementById('confirm-input');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        let confirmBtn = document.getElementById('confirm-btn');
        

        // --- INITIALIZATION ---
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                onAuthStateChanged(auth, async user => {
                    if (user) {
                        await fetchUserProfile(user);
                        loginScreen.classList.add('hidden');
                        dashboardScreen.classList.remove('hidden');
                        dashboardScreen.classList.add('flex');
                        initializeDataListeners();
                        setupView('dashboard-content');
                        checkForActiveOrder(user.uid);
                    } else {
                        loginScreen.classList.remove('hidden');
                        dashboardScreen.classList.add('hidden');
                        unsubscribeAll();
                    }
                });
            });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
             if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Firebase email/password sign-in failed:", error);
                alert("Login failed. Please check your email and password.");
            }
        });

        async function fetchUserProfile(user) {
            const q = query(collection(db, "users"), where("uid", "==", user.uid));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                currentUserProfile = { id: querySnapshot.docs[0].id, uid: user.uid, ...querySnapshot.docs[0].data() };
                userAvatarBtn.title = currentUserProfile.name;
                const initials = currentUserProfile.name.split(' ').map(n => n[0]).join('');
                userAvatarBtn.textContent = initials;

            } else {
                console.error("Could not find user profile in Firestore.");
                currentUserProfile = { uid: user.uid, email: user.email, name: "New User"};
            }
        }

        function initializeDataListeners() {
            unsubscribeAll(); // Clear old listeners before creating new ones

            if (!currentUserProfile) return;

            const isSuperAdmin = currentUserProfile.role === 'Super Admin';
            const assignedRestaurants = currentUserProfile.restaurants || [];

            const unsubRestaurants = onSnapshot(collection(db, "restaurants"), (snapshot) => {
                const allRestaurants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isSuperAdmin) {
                    restaurantData = allRestaurants;
                } else {
                    restaurantData = allRestaurants.filter(r => assignedRestaurants.includes(r.name));
                }
                renderAll();
            });

            const unsubUsers = onSnapshot(collection(db, "users"), (snapshot) => {
                const allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isSuperAdmin) {
                    userData = allUsers;
                } else {
                    userData = allUsers.filter(user => user.restaurants.some(r => assignedRestaurants.includes(r)));
                }
                renderAll();
            });

            const unsubMenu = onSnapshot(collection(db, "menuItems"), (snapshot) => {
                const allMenuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isSuperAdmin) {
                    menuData = allMenuItems;
                } else {
                    const assignedRestaurantIds = restaurantData.map(r => r.id);
                    menuData = allMenuItems.filter(item => assignedRestaurantIds.includes(item.restaurantId));
                }
                renderAll();
            });

            unsubscribeListeners = [unsubRestaurants, unsubUsers, unsubMenu];
        }

        function unsubscribeAll() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            if(currentOrderUnsubscribe) {
                currentOrderUnsubscribe();
                currentOrderUnsubscribe = null;
            }
        }


        // --- EVENT LISTENERS ---
        menuButton.addEventListener('click', () => mobileMenu.classList.remove('-translate-x-full'));
        closeMenuButton.addEventListener('click', () => mobileMenu.classList.add('-translate-x-full'));
        searchInput.addEventListener('keyup', handleSearch);
        restaurantFilter.addEventListener('change', () => renderUserTable());
        menuRestaurantFilter.addEventListener('change', () => renderMenuTable());
        userAvatarBtn.addEventListener('click', () => logoutDropdown.classList.toggle('hidden'));
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            orderStatusFooter.classList.add('hidden');
        });
        document.getElementById('order-restaurant-filter').addEventListener('change', renderOrderFoodPage);


        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                setupView(link.dataset.target);
                mobileMenu.classList.add('-translate-x-full');
            });
        });

        // Restaurant Modal listeners
        addRestaurantBtn.addEventListener('click', () => openRestaurantModal('add'));
        closeModalBtn.addEventListener('click', closeRestaurantModal);
        cancelModalBtn.addEventListener('click', closeRestaurantModal);
        restaurantForm.addEventListener('submit', handleRestaurantFormSubmit);
        restaurantTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            if (editButton) openRestaurantModal('edit', editButton.closest('tr').dataset.id);
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) handleDeleteRestaurant(deleteButton.closest('tr').dataset.id);
        });
        ownerSearchInput.addEventListener('focus', () => ownerDropdown.classList.remove('hidden'));
        ownerSearchInput.addEventListener('blur', () => setTimeout(() => ownerDropdown.classList.add('hidden'), 150));
        ownerSearchInput.addEventListener('keyup', filterOwners);

        // User Modal Listeners
        addUserBtn.addEventListener('click', () => openUserModal('add'));
        closeUserModalBtn.addEventListener('click', closeUserModal);
        cancelUserModalBtn.addEventListener('click', closeUserModal);
        userForm.addEventListener('submit', handleUserFormSubmit);
        userTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-user-btn');
            if (editButton) openUserModal('edit', editButton.closest('tr').dataset.id);
            const deleteButton = e.target.closest('.delete-user-btn');
            if (deleteButton) handleDeleteUser(deleteButton.closest('tr').dataset.id);
            const resetPasswordButton = e.target.closest('.reset-password-btn');
            if (resetPasswordButton) handleResetPassword(resetPasswordButton.closest('tr').dataset.id);
        });
        restaurantSearchInput.addEventListener('focus', () => restaurantDropdown.classList.remove('hidden'));
        restaurantSearchInput.addEventListener('blur', () => setTimeout(() => restaurantDropdown.classList.add('hidden'), 150));
        restaurantSearchInput.addEventListener('keyup', filterRestaurantsForDropdown);

        // Menu Item Modal Listeners
        addMenuItemBtn.addEventListener('click', () => openMenuItemModal('add'));
        closeMenuItemModalBtn.addEventListener('click', closeMenuItemModal);
        cancelMenuItemModalBtn.addEventListener('click', closeMenuItemModal);
        menuItemForm.addEventListener('submit', handleMenuItemFormSubmit);
        menuTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-menu-item-btn');
            if (editButton) openMenuItemModal('edit', editButton.closest('tr').dataset.id);
        });
        generateDescriptionBtn.addEventListener('click', handleGenerateDescription);
        generateImageBtn.addEventListener('click', handleGenerateImage);
        uploadImageBtn.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', handleImageUpload);

        // Confirm Modal Listeners
        cancelConfirmBtn.addEventListener('click', () => confirmModal.style.display = 'none');
        
        // Cart Listeners
        cartButton.addEventListener('click', () => cartPanel.classList.remove('translate-x-full'));
        closeCartBtn.addEventListener('click', () => {
            cartPanel.classList.add('translate-x-full');
            if (currentActiveOrder && !['Delivered', 'Cancelled'].includes(currentActiveOrder.status)) {
                orderStatusFooter.classList.remove('hidden');
            }
        });
        confirmOrderBtn.addEventListener('click', handleConfirmOrder);
        interactiveMenuItemsContainer.addEventListener('click', handleOrderInteraction);
        cartItemsContainer.addEventListener('click', handleCartInteraction);
        editOrderBtn.addEventListener('click', handleEditOrder);


        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderRestaurantTable();
            renderUserTable();
            renderMenuTable();
            populateAllRestaurantFilters();
            renderDashboard();
            if (currentView === 'order-food-content') {
                renderOrderFoodPage();
            }
        }

        function renderDashboard() {
            if (currentView !== 'dashboard-content') return;

            document.getElementById('total-restaurants').textContent = restaurantData.length;
            document.getElementById('total-users').textContent = userData.length;
            document.getElementById('total-menu-items').textContent = menuData.length;

            renderMenuItemsChart();
        }

        let menuItemsChart = null;
        function renderMenuItemsChart() {
            const chartCanvas = document.getElementById('menu-items-chart');
            if (!chartCanvas) return;

            const ctx = chartCanvas.getContext('2d');
            const data = {
                labels: [],
                datasets: [{
                    label: '# of Menu Items',
                    data: [],
                    backgroundColor: 'rgba(17, 24, 39, 0.8)',
                    borderColor: 'rgba(17, 24, 39, 1)',
                    borderWidth: 1
                }]
            };

            const menuCountByRestaurant = menuData.reduce((acc, item) => {
                const restaurant = restaurantData.find(r => r.id === item.restaurantId);
                if (restaurant) {
                    acc[restaurant.name] = (acc[restaurant.name] || 0) + 1;
                }
                return acc;
            }, {});

            // Also include restaurants with 0 menu items
            restaurantData.forEach(r => {
                if (!menuCountByRestaurant[r.name]) {
                    menuCountByRestaurant[r.name] = 0;
                }
            });

            data.labels = Object.keys(menuCountByRestaurant);
            data.datasets[0].data = Object.values(menuCountByRestaurant);

            if (menuItemsChart) {
                menuItemsChart.destroy();
            }

            menuItemsChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }


        function renderRestaurantTable() {
            restaurantTableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = (currentView === 'restaurant-management-content' && searchTerm)
                ? restaurantData.filter(r => r.name.toLowerCase().includes(searchTerm) || (r.owner && r.owner.toLowerCase().includes(searchTerm)))
                : restaurantData;

            if (restaurantData.length === 0) {
                showEmptyState(restaurantTableBody, 8, 'No restaurants found.', 'Add Restaurant', () => openRestaurantModal('add'));
            } else if (filteredData.length === 0) {
                showEmptyState(restaurantTableBody, 8, 'No results found for your search.');
            } else {
                filteredData.forEach((res, index) => {
                    const newRow = restaurantTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = res.id;
                    newRow.innerHTML = `
                        <td data-label="Name" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs font-medium text-gray-900">${res.name}</td>
                        <td data-label="Owner" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-blue-500 font-medium underline">${res.owner || ''}</td>
                        <td data-label="Contact" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${res.contact}</td>
                        <td data-label="Address" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${res.address}</td>
                        <td data-label="Onboarding" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${res.onboarding}</td>
                        <td data-label="Plan" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${res.plan === 'Premium' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800'}">${res.plan}</span></td>
                        <td data-label="Payment" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">₹${res.payment}</td>
                        <td data-label="Action" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2 justify-end">
                            <button class="edit-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="delete-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
            lucide.createIcons();
        }
         
        function renderMenuTable() {
            menuTableBody.innerHTML = '';
            const selectedRestaurantId = menuRestaurantFilter.value;
            if (!selectedRestaurantId) {
                showEmptyState(menuTableBody, 8, 'Please select a restaurant to see its menu.');
                return;
            }

            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = menuData.filter(item => {
                const restaurantMatch = item.restaurantId === selectedRestaurantId;
                const searchMatch = (currentView === 'menu-content' && searchTerm)
                    ? item.name.toLowerCase().includes(searchTerm) || item.category.toLowerCase().includes(searchTerm)
                    : true;
                return restaurantMatch && searchMatch;
            });

            if (filteredData.length === 0 && !searchTerm) {
                showEmptyState(menuTableBody, 8, 'No menu items for this restaurant yet.', 'Add Item', () => openMenuItemModal('add'));
            } else if (filteredData.length === 0) {
                showEmptyState(menuTableBody, 8, 'No results found for your search.');
            } else {
                filteredData.forEach((item, index) => {
                    const restaurant = restaurantData.find(r => r.id === item.restaurantId);
                    const newRow = menuTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = item.id;
                    newRow.innerHTML = `
                        <td class="p-4 text-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded menu-item-checkbox" data-id="${item.id}"></td>
                        <td data-label="Image" class="px-2 py-1 md:px-4 md:py-2"><img src="${item.imageUrl || 'https://placehold.co/40x40/e2e8f0/e2e8f0?text=.'}" class="w-10 h-10 object-cover rounded"></td>
                        <td data-label="Name" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs font-medium text-gray-900">${item.name}</td>
                        <td data-label="Restaurant" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${restaurant ? restaurant.name : ''}</td>
                        <td data-label="Category" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${item.category}</td>
                        <td data-label="Price" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">₹${item.price}</td>
                        <td data-label="Prep Time" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${item.prepTime} mins</td>
                        <td data-label="Action" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2 justify-end">
                            <button class="edit-menu-item-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="delete-menu-item-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
             lucide.createIcons();
        }

        function renderUserTable() {
            userTableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRestaurant = restaurantFilter.value;
            
            const filteredData = userData.filter(user => {
                const searchMatch = (currentView === 'user-management-content' && searchTerm)
                    ? user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)
                    : true;
                const filterMatch = selectedRestaurant === 'all' || user.restaurants.includes(selectedRestaurant);
                return searchMatch && filterMatch;
            });

            if (userData.length === 0) {
                showEmptyState(userTableBody, 8, 'No users found.', 'Add User', () => openUserModal('add'));
            } else if (filteredData.length === 0) {
                 showEmptyState(userTableBody, 8, 'No results found for your search or filter.');
            } else {
                filteredData.forEach((user, index) => {
                    const newRow = userTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = user.id;
                    const restaurantHTML = user.restaurants.map(r => `<span class="px-2 py-0.5 bg-gray-200 text-gray-800 rounded-full text-xs">${r}</span>`).join('');
                    newRow.innerHTML = `
                        <td class="p-4 text-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded user-checkbox" data-id="${user.id}"></td>
                        <td data-label="Name" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs font-medium text-gray-900">${user.name}</td>
                        <td data-label="Email" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${user.email}</td>
                        <td data-label="Restaurant" class="px-2 py-1 md:px-4 md:py-2 text-xs text-gray-500"><div class="flex flex-wrap gap-1 justify-end">${restaurantHTML}</div></td>
                        <td data-label="Status" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${user.status}</span></td>
                        <td data-label="Role" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${user.role}</td>
                        <td data-label="Last Login" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500">${user.lastLogin}</td>
                        <td data-label="Action" class="px-2 py-1 md:px-4 md:py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2 justify-end">
                            <button class="edit-user-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="reset-password-btn"><i data-lucide="key-round" class="w-5 h-5 text-gray-500"></i></button>
                            <button class="delete-user-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
            lucide.createIcons();
        }

        function showEmptyState(tbody, colspan, message, buttonText = null, buttonAction = null) {
            const row = tbody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = colspan;
            cell.className = 'text-center py-12';
            
            let buttonHtml = '';
            if (buttonText && buttonAction) {
                buttonHtml = `<button id="empty-state-btn" class="glass-button-blue px-3 py-1.5 rounded-md text-xs mt-4">${buttonText}</button>`;
            }

            cell.innerHTML = `
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">${message}</h3>
                    ${buttonHtml}
                </div>
            `;
            
            if (buttonAction) {
                cell.querySelector('#empty-state-btn').addEventListener('click', buttonAction);
            }
        }

        // --- GENERAL FUNCTIONS ---
        function setupView(targetId) {
            currentView = targetId;
            contentSections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) targetSection.classList.remove('hidden');

            document.getElementById('restaurant-actions').style.display = 'none';
            document.getElementById('menu-actions').style.display = 'none';
            document.getElementById('user-actions').style.display = 'none';
            document.getElementById('order-food-actions').style.display = 'none';

            if (targetId === 'restaurant-management-content') {
                headerTitle.textContent = 'Restaurant Management';
                document.getElementById('restaurant-actions').style.display = 'flex';
            } else if (targetId === 'menu-content') {
                headerTitle.textContent = 'Menu Management';
                document.getElementById('menu-actions').style.display = 'flex';
                const menuFilter = document.getElementById('menuRestaurantFilter');
                if (menuFilter.value === '' && menuFilter.options.length > 1) {
                    menuFilter.value = menuFilter.options[1].value;
                    menuFilter.dispatchEvent(new Event('change'));
                }
            } else if (targetId === 'user-management-content') {
                headerTitle.textContent = 'User Management';
                document.getElementById('user-actions').style.display = 'flex';
            } else if (targetId === 'order-food-content') {
                 headerTitle.textContent = 'Order Food';
                 document.getElementById('order-food-actions').style.display = 'flex';
            } else if (targetId === 'dashboard-content') {
                 headerTitle.textContent = 'Dashboard';
            }

            document.querySelectorAll('#sidebar-nav a, #mobile-nav a').forEach(nav => {
                nav.classList.remove('bg-gray-900', 'text-white');
                nav.classList.add('text-gray-300');
                if (nav.dataset.target === targetId) {
                    nav.classList.add('bg-gray-900', 'text-white');
                    nav.classList.remove('text-gray-300');
                }
            });
            handleSearch(); // Re-filter on view change
        }

        function handleSearch() {
            if (currentView === 'restaurant-management-content') {
                renderRestaurantTable();
            } else if (currentView === 'user-management-content') {
                renderUserTable();
            } else if (currentView === 'menu-content') {
                renderMenuTable();
            }
        }

        function populateAllRestaurantFilters() {
            const restaurantNames = new Set(restaurantData.map(r => r.name));
            
            // For user management filter
            const userFilter = document.getElementById('restaurantFilter');
            if (userFilter) {
                const existingUserFilterOptions = userFilter.querySelectorAll('option:not([value="all"])');
                existingUserFilterOptions.forEach(opt => opt.remove());
                restaurantNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    userFilter.appendChild(option);
                });
            }

            // For menu management filter
            const menuFilter = document.getElementById('menuRestaurantFilter');
            if(menuFilter) {
                const existingMenuFilterOptions = menuFilter.querySelectorAll('option:not([value=""])');
                existingMenuFilterOptions.forEach(opt => opt.remove());
                restaurantData.forEach(res => {
                    const option = document.createElement('option');
                    option.value = res.id;
                    option.textContent = res.name;
                    menuFilter.appendChild(option);
                });
            }
             // For order food filter
            const orderFilter = document.getElementById('order-restaurant-filter');
            if (orderFilter) {
                const existingOrderFilterOptions = orderFilter.querySelectorAll('option:not([value=""])');
                existingOrderFilterOptions.forEach(opt => opt.remove());
                restaurantData.forEach(res => {
                    const option = document.createElement('option');
                    option.value = res.id;
                    option.textContent = res.name;
                    orderFilter.appendChild(option);
                });
            }
        }

        // --- RESTAURANT MODAL ---
        function openRestaurantModal(mode, id = null) {
            restaurantForm.reset();
            populateOwnerDropdown();
            if (mode === 'add') {
                modalTitle.textContent = 'Add Restaurant';
                document.getElementById('res-id').value = '';
            } else if (mode === 'edit' && id) {
                modalTitle.textContent = 'Edit Restaurant';
                const res = restaurantData.find(r => r.id === id);
                if(res) {
                    document.getElementById('res-id').value = res.id;
                    document.getElementById('res-name').value = res.name;
                    document.getElementById('res-owner-search').value = res.owner;
                    document.getElementById('res-contact').value = res.contact;
                    document.getElementById('res-address').value = res.address;
                    document.getElementById('res-onboarding').value = res.onboarding;
                    document.getElementById('res-plan').value = res.plan;
                    document.getElementById('res-payment').value = res.payment;
                }
            }
            restaurantModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeRestaurantModal() {
            restaurantModal.style.display = 'none';
        }

        async function handleRestaurantFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('res-id').value;
            const newName = document.getElementById('res-name').value;
            const originalRestaurant = id ? restaurantData.find(r => r.id === id) : null;
            const originalName = originalRestaurant ? originalRestaurant.name : null;

            const formData = {
                name: newName,
                owner: document.getElementById('res-owner-search').value,
                contact: document.getElementById('res-contact').value,
                address: document.getElementById('res-address').value,
                onboarding: document.getElementById('res-onboarding').value,
                plan: document.getElementById('res-plan').value,
                payment: parseFloat(document.getElementById('res-payment').value).toFixed(2)
            };

            if (id) {
                await updateDoc(doc(db, "restaurants", id), formData);
                // If name changed, update users
                if(originalName && newName !== originalName) {
                    const usersToUpdate = userData.filter(u => u.restaurants.includes(originalName));
                    const batch = writeBatch(db);
                    usersToUpdate.forEach(u => {
                        const userRef = doc(db, "users", u.id);
                        const updatedRestaurants = u.restaurants.map(r => r === originalName ? newName : r);
                        batch.update(userRef, { restaurants: updatedRestaurants });
                    });
                    await batch.commit();
                }
            } else {
                await addDoc(collection(db, "restaurants"), formData);
            }
            closeRestaurantModal();
        }

        function populateOwnerDropdown() {
            ownerDropdown.innerHTML = '';
            const userNames = new Set(userData.map(u => u.name));
            userNames.forEach(name => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = name;
                optionDiv.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
                optionDiv.addEventListener('mousedown', () => {
                    ownerSearchInput.value = name;
                    ownerDropdown.classList.add('hidden');
                });
                ownerDropdown.appendChild(optionDiv);
            });
        }

        function filterOwners() {
            const filter = ownerSearchInput.value.toLowerCase();
            const options = ownerDropdown.getElementsByTagName('div');
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent.toLowerCase().includes(filter)) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

         // --- USER MODAL ---
        function openUserModal(mode, id = null) {
            userForm.reset();
            clearMultiSelect();
            const passwordInput = document.getElementById('user-password');
            if (mode === 'add') {
                userModalTitle.textContent = 'Add User';
                document.getElementById('user-id').value = '';
                passwordInput.disabled = false;
                passwordInput.required = true;
                passwordInput.placeholder = '••••••••';
            } else if (mode === 'edit' && id) {
                userModalTitle.textContent = 'Edit User';
                passwordInput.disabled = true;
                passwordInput.required = false;
                passwordInput.placeholder = 'Password cannot be changed here';
                const user = userData.find(u => u.id === id);
                if (user) {
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-name').value = user.name;
                    document.getElementById('user-email').value = user.email;
                    user.restaurants.forEach(addRestaurantToMultiSelect);
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('user-role').value = user.role;
                }
            }
            populateRestaurantDropdown();
            userModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeUserModal() {
            userModal.style.display = 'none';
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const newName = document.getElementById('user-name').value;
            const originalUser = id ? userData.find(u => u.id === id) : null;
            const originalName = originalUser ? originalUser.name : null;

            const selectedRestaurants = Array.from(multiSelectContainer.querySelectorAll('.multi-select-pill')).map(pill => pill.dataset.value);
            
            const firestoreData = {
                name: newName,
                email: email,
                restaurants: selectedRestaurants,
                status: document.getElementById('user-status').value,
                role: document.getElementById('user-role').value,
                lastLogin: 'Never'
            };
            
            if (id) { // Editing an existing user
                await updateDoc(doc(db, "users", id), firestoreData);
                if(originalName && newName !== originalName) {
                    const restaurantsToUpdate = restaurantData.filter(r => r.owner === originalName);
                     const batch = writeBatch(db);
                    restaurantsToUpdate.forEach(r => {
                        const resRef = doc(db, "restaurants", r.id);
                        batch.update(resRef, { owner: newName });
                    });
                    await batch.commit();
                }
            } else { // Creating a new user
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await addDoc(collection(db, "users"), { ...firestoreData, uid: user.uid });
                } catch (error) {
                    console.error("Error creating user:", error);
                    alert(`Could not create user: ${error.message}`);
                    return; // Stop execution if auth user creation fails
                }
            }
            closeUserModal();
        }

        // Multi-select functions
        function populateRestaurantDropdown() {
            restaurantDropdown.innerHTML = '';
            const selected = getSelectedRestaurants();
            const available = restaurantData.map(r => r.name).filter(r => !selected.includes(r));
            
            available.forEach(name => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = name;
                optionDiv.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
                optionDiv.addEventListener('mousedown', () => {
                    addRestaurantToMultiSelect(name);
                    populateRestaurantDropdown();
                });
                restaurantDropdown.appendChild(optionDiv);
            });
        }
        
        function addRestaurantToMultiSelect(name) {
            const pill = document.createElement('span');
            pill.className = 'multi-select-pill flex items-center bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full';
            pill.dataset.value = name;
            pill.innerHTML = `
                ${name}
                <button type="button" class="ml-1.5 -mr-1 flex-shrink-0 inline-flex items-center justify-center h-4 w-4 rounded-full text-blue-400 hover:bg-blue-200 hover:text-blue-500 focus:outline-none focus:bg-blue-500 focus:text-white">
                    <i data-lucide="x" class="h-3 w-3"></i>
                </button>
            `;
            pill.querySelector('button').addEventListener('click', () => {
                pill.remove();
                populateRestaurantDropdown();
            });
            multiSelectContainer.insertBefore(pill, restaurantSearchInput);
            lucide.createIcons({nodes: [pill]});
        }

        function getSelectedRestaurants() {
            return Array.from(multiSelectContainer.querySelectorAll('.multi-select-pill')).map(pill => pill.dataset.value);
        }

        function clearMultiSelect() {
            multiSelectContainer.querySelectorAll('.multi-select-pill').forEach(pill => pill.remove());
            restaurantSearchInput.value = '';
        }

        function filterRestaurantsForDropdown() {
            const filter = restaurantSearchInput.value.toLowerCase();
            const options = restaurantDropdown.getElementsByTagName('div');
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent.toLowerCase().includes(filter)) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

        // --- MENU ITEM MODAL ---
        function openMenuItemModal(mode, id = null) {
            menuItemForm.reset();
            fileToUpload = null;
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');

            if (mode === 'add') {
                menuItemModalTitle.textContent = 'Add Menu Item';
                document.getElementById('menu-item-id').value = '';
            } else if (mode === 'edit' && id) {
                menuItemModalTitle.textContent = 'Edit Menu Item';
                const item = menuData.find(i => i.id === id);
                if (item) {
                    document.getElementById('menu-item-id').value = item.id;
                    document.getElementById('item-name').value = item.name;
                    document.getElementById('item-description').value = item.description;
                    document.getElementById('item-image-url').value = item.imageUrl;
                    if(item.imageUrl) {
                        imagePreview.src = item.imageUrl;
                        imagePreview.classList.remove('hidden');
                        imagePlaceholder.classList.add('hidden');
                    }
                    document.getElementById('item-price').value = item.price;
                    document.getElementById('item-cuisine').value = item.cuisine;
                    document.getElementById('item-taste').value = item.taste;
                    document.getElementById('item-category').value = item.category;
                    document.getElementById('item-prep-time').value = item.prepTime;
                    
                    const checkboxes = menuItemForm.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = item.portionSizes.includes(cb.value);
                    });
                }
            }
            menuItemModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeMenuItemModal() {
            menuItemModal.style.display = 'none';
        }

        function resizeImage(file, maxWidth = 1024, maxHeight = 1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob.size > 1024 * 1024) {
                                // If still too large, you could add another resize step or just resolve.
                                // For now, we'll just log a warning and proceed.
                                console.warn("Image is still larger than 1MB after resize.", blob.size);
                            }
                            resolve(blob);
                        }, file.type, 0.9); // 0.9 is quality, good for JPEGs
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function handleMenuItemFormSubmit(e) {
            e.preventDefault();
            const saveButton = menuItemForm.querySelector('button[type="submit"]');
            saveButton.disabled = true;
            let originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = '<div class="loader"></div>';

            try {
                const id = document.getElementById('menu-item-id').value;
                const selectedPortions = Array.from(menuItemForm.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                let imageUrl = document.getElementById('item-image-url').value;

                if (fileToUpload) {
                    const resizedFile = await resizeImage(fileToUpload);
                    const storageRef = ref(storage, `menuItems/${Date.now()}_${fileToUpload.name}`);
                    const uploadTask = uploadBytesResumable(storageRef, resizedFile);

                    await new Promise((resolve, reject) => {
                         uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                saveButton.innerHTML = `Uploading ${progress.toFixed(0)}%`;
                            },
                            (error) => {
                                console.error("Upload failed:", error);
                                reject(error);
                            },
                            async () => {
                                imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                                resolve();
                            }
                        );
                    });
                }
                
                saveButton.textContent = 'Saving...';
                
                const formData = {
                    restaurantId: menuRestaurantFilter.value,
                    name: document.getElementById('item-name').value,
                    description: document.getElementById('item-description').value,
                    imageUrl: imageUrl,
                    price: parseFloat(document.getElementById('item-price').value).toFixed(2),
                    cuisine: document.getElementById('item-cuisine').value,
                    taste: document.getElementById('item-taste').value,
                    category: document.getElementById('item-category').value,
                    prepTime: document.getElementById('item-prep-time').value,
                    portionSizes: selectedPortions
                };

                if (id) {
                    await updateDoc(doc(db, "menuItems", id), formData);
                } else {
                    await addDoc(collection(db, "menuItems"), formData);
                }
                fileToUpload = null;
                closeMenuItemModal();
            } catch (error) {
                console.error("Error saving menu item:", error);
                alert("Failed to save menu item. This is often due to incorrect Firebase Storage security rules. Please check the console for more details.");
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }
        
        function handleImageUpload(event) {
            const newFile = event.target.files[0];
            if (newFile) {
                fileToUpload = newFile; // This now correctly discards any previously selected file
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                }
                reader.readAsDataURL(fileToUpload);
            }
        }

        // --- DELETION & CONFIRMATION ---
        function openConfirmModal({ title, message, requiresInput, onConfirm }) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmInput.value = '';

            if (requiresInput) {
                confirmInputContainer.style.display = 'block';
                confirmBtn.disabled = true;
                confirmInput.onkeyup = () => {
                    confirmBtn.disabled = confirmInput.value !== 'Delete';
                };
            } else {
                confirmInputContainer.style.display = 'none';
                confirmBtn.disabled = false;
            }

            confirmModal.style.display = 'flex';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                confirmModal.style.display = 'none';
            });
            confirmBtn = newConfirmBtn;
        }

        async function handleDeleteRestaurant(id) {
            const restaurant = restaurantData.find(r => r.id === id);
            openConfirmModal({
                title: `Delete ${restaurant.name}`,
                message: `This action cannot be undone. This will permanently delete the restaurant.`,
                requiresInput: true,
                onConfirm: async () => {
                    await deleteDoc(doc(db, "restaurants", id));
                }
            });
        }

        async function handleDeleteUser(id) {
            const user = userData.find(u => u.id === id);
            openConfirmModal({
                title: `Delete ${user.name}`,
                message: `Are you sure you want to delete this user? This action cannot be undone.`,
                requiresInput: false,
                onConfirm: async () => {
                    await deleteDoc(doc(db, "users", id));
                }
            });
        }

        async function handleResetPassword(id) {
            const user = userData.find(u => u.id === id);
            if (user && user.email) {
                try {
                    await sendPasswordResetEmail(auth, user.email);
                    alert(`Password reset email sent to ${user.email}`);
                } catch (error) {
                    console.error("Error sending password reset email:", error);
                    alert("Could not send password reset email.");
                }
            }
        }

        // --- AI FUNCTIONS ---
        // Helper function to convert Base64 to Blob
        function b64toBlob(b64Data, contentType='', sliceSize=512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, {type: contentType});
        }


        async function handleGenerateDescription(e) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                alert("Please add your Gemini API Key to the script.");
                return;
            }

            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';

            const userPrompt = `Generate a short, impactful menu description under 100 characters for a dish with these details. Do not use any markdown formatting:
            - Name: ${document.getElementById('item-name').value}
            - Category: ${document.getElementById('item-category').value}
            - Cuisine: ${document.getElementById('item-cuisine').value}
            - Taste Profile: ${document.getElementById('item-taste').value}
            - Price: ₹${document.getElementById('item-price').value}`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: userPrompt }] }] };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const description = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (description) {
                    document.getElementById('item-description').value = description.trim().replace(/\*/g, '');
                } else {
                     throw new Error("No description found in API response.");
                }
            } catch (error) {
                console.error("Error generating description:", error);
                alert("Failed to generate description. Check the console for details.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Generate with AI';
                lucide.createIcons();
            }
        }

        async function handleGenerateImage(e) {
             if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                alert("Please add your Gemini API Key to the script.");
                return;
            }
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';
            imageLoader.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            imagePlaceholder.classList.add('hidden');

            const userPrompt = `Professional, vibrant food photography of a dish named "${document.getElementById('item-name').value}". It is a ${document.getElementById('item-cuisine').value} ${document.getElementById('item-category').value} with a ${document.getElementById('item-taste').value} taste profile. The dish should look delicious and be presented on a clean, modern plate.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`;
            const payload = { instances: [{ prompt: userPrompt }], parameters: { "sampleCount": 1} };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
                if (base64Data) {
                    const blob = b64toBlob(base64Data, 'image/png');
                    const fileName = `ai-generated-${Date.now()}.png`;
                    fileToUpload = new File([blob], fileName, { type: 'image/png' });
                    
                    imagePreview.src = URL.createObjectURL(fileToUpload);
                    imagePreview.classList.remove('hidden');

                } else {
                    throw new Error("No image data found in API response.");
                }
            } catch (error) {
                console.error("Error generating image:", error);
                alert("Failed to generate image. Check the console for details.");
                imagePlaceholder.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Generate';
                lucide.createIcons();
                imageLoader.classList.add('hidden');
            }
        }
        
        // --- ORDER FOOD PAGE ---
        function renderOrderFoodPage() {
            const selectedRestaurantId = document.getElementById('order-restaurant-filter').value;
            const interactiveFiltersContainer = document.getElementById('interactive-filters');
            const menuItemsContainer = document.getElementById('interactive-menu-items');
            const allItemsCount = document.getElementById('all-items-count');

            if (!selectedRestaurantId) {
                interactiveFiltersContainer.innerHTML = '';
                menuItemsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Please select a restaurant to view the menu.</p>';
                allItemsCount.textContent = 'All Items';
                return;
            }

            const restaurant = restaurantData.find(r => r.id === selectedRestaurantId);
            if (restaurant) {
                headerTitle.textContent = restaurant.name;
            }

            const currentMenu = menuData.filter(item => item.restaurantId === selectedRestaurantId);

            // Populate filters
            populateInteractiveFilters(currentMenu);

            // Render items
            renderInteractiveMenuItems(currentMenu);
        }

        function populateInteractiveFilters(menu) {
            const container = document.getElementById('interactive-filters');
            const allCuisines = [...new Set(menu.map(item => item.cuisine))];
            const allTastes = [...new Set(menu.map(item => item.taste))];

            const createFilterGroup = (title, icon, options, dataKey) => {
                const buttons = options.map(opt => `<button class="filter-btn border rounded-md px-3 py-1.5 text-xs" data-filter="${dataKey}" data-value="${opt}">${opt}</button>`).join('');
                return `
                    <div class="space-y-2">
                        <h4 class="flex items-center text-xs font-semibold text-gray-600"><i data-lucide="${icon}" class="w-4 h-4 mr-2"></i> ${title}</h4>
                        <div class="flex flex-wrap gap-2">${buttons}</div>
                    </div>
                `;
            };
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${createFilterGroup('Portion Size', 'users', ['S', 'M', 'L'], 'portion')}
                    ${createFilterGroup('Cuisine Type', 'utensils', allCuisines, 'cuisine')}
                    ${createFilterGroup('Taste Preference', 'heart', allTastes, 'taste')}
                    ${createFilterGroup('Preparation Speed', 'clock', ['Fast', 'Med', 'Slow'], 'prep')}
                </div>
            `;
            lucide.createIcons();
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    applyOrderFilters();
                });
            });
        }

        function applyOrderFilters() {
            const selectedRestaurantId = document.getElementById('order-restaurant-filter').value;
            let filteredMenu = menuData.filter(item => item.restaurantId === selectedRestaurantId);

            const activeFilters = {
                portion: Array.from(document.querySelectorAll('[data-filter="portion"].active')).map(b => b.dataset.value),
                cuisine: Array.from(document.querySelectorAll('[data-filter="cuisine"].active')).map(b => b.dataset.value),
                taste: Array.from(document.querySelectorAll('[data-filter="taste"].active')).map(b => b.dataset.value),
                prep: Array.from(document.querySelectorAll('[data-filter="prep"].active')).map(b => b.dataset.value),
            };

            if (activeFilters.portion.length > 0) {
                const portionMap = { 'S': 'Small', 'M': 'Medium', 'L': 'Large' };
                const selectedPortions = activeFilters.portion.map(p => portionMap[p]);
                filteredMenu = filteredMenu.filter(item => item.portionSizes.some(p => selectedPortions.includes(p)));
            }
             if (activeFilters.cuisine.length > 0) {
                filteredMenu = filteredMenu.filter(item => activeFilters.cuisine.includes(item.cuisine));
            }
            if (activeFilters.taste.length > 0) {
                filteredMenu = filteredMenu.filter(item => activeFilters.taste.includes(item.taste));
            }
            if (activeFilters.prep.length > 0) {
                filteredMenu = filteredMenu.filter(item => {
                    const prepTime = parseInt(item.prepTime);
                    if (activeFilters.prep.includes('Fast') && prepTime <= 15) return true;
                    if (activeFilters.prep.includes('Med') && prepTime > 15 && prepTime <= 30) return true;
                    if (activeFilters.prep.includes('Slow') && prepTime > 30) return true;
                    return false;
                });
            }
            
            renderInteractiveMenuItems(filteredMenu);
        }

        function renderInteractiveMenuItems(menu) {
            const container = document.getElementById('interactive-menu-items');
            document.getElementById('all-items-count').textContent = `All Items (${menu.length} items)`;
            container.innerHTML = '';
            
            if (menu.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No items match your filters.</p>';
                return;
            }

            menu.forEach(item => {
                const tagsHTML = [item.category, item.cuisine].map(tag => `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${tag}</span>`).join('');
                const detailsHTML = [
                    {icon: 'users', text: item.portionSizes.join(', ')},
                    {icon: 'heart', text: item.taste},
                    {icon: 'clock', text: `${item.prepTime} min prep`}
                ].map(detail => `<div class="flex items-center text-xs text-gray-500"><i data-lucide="${detail.icon}" class="w-3.5 h-3.5 mr-1.5"></i> ${detail.text}</div>`).join('');

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex items-center';
                card.innerHTML = `
                    <div class="w-40 h-40 flex-shrink-0">
                        <img src="${item.imageUrl || 'https://placehold.co/400x400/e2e8f0/e2e8f0?text=.'}" alt="${item.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 flex-1 self-stretch flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-gray-900">${item.name}</h4>
                                <span class="text-lg font-bold text-gray-900">₹${item.price}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1 mb-3">${item.description}</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${tagsHTML}
                            </div>
                            <div class="flex flex-wrap gap-x-4 gap-y-2">
                               ${detailsHTML}
                            </div>
                        </div>
                        <div class="order-button-container mt-4 w-full" data-item-id="${item.id}">
                            ${getOrderItemHTML(item.id)}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }
        
        // --- CART FUNCTIONS ---
        function getOrderItemHTML(itemId) {
            const itemInCart = cart[itemId];
            if (itemInCart && itemInCart.quantity > 0) {
                return `
                    <div class="flex items-center justify-between w-full">
                        <button class="quantity-change-btn w-8 h-8 rounded-md glass-button-blue text-lg font-bold" data-item-id="${itemId}" data-change="-1">-</button>
                        <span class="text-lg font-bold w-8 text-center">${itemInCart.quantity}</span>
                        <button class="quantity-change-btn w-8 h-8 rounded-md glass-button-blue text-lg font-bold" data-item-id="${itemId}" data-change="1">+</button>
                    </div>
                `;
            } else {
                return `
                    <button class="add-to-cart-btn w-full glass-button-blue font-semibold py-2 rounded-md flex items-center justify-center gap-2">
                        <i data-lucide="utensils-crossed" class="w-4 h-4"></i> Add to Order
                    </button>
                `;
            }
        }
        
        function handleCartInteraction(e) {
            const quantityChangeBtn = e.target.closest('.cart-quantity-change-btn');
             if (quantityChangeBtn) {
                const itemId = quantityChangeBtn.dataset.itemId;
                const change = parseInt(quantityChangeBtn.dataset.change, 10);
                updateCart(itemId, change);
            }
        }

        function handleOrderInteraction(e) {
            const addToCartBtn = e.target.closest('.add-to-cart-btn');
            const quantityChangeBtn = e.target.closest('.quantity-change-btn');

            if (addToCartBtn) {
                const container = addToCartBtn.parentElement;
                const itemId = container.dataset.itemId;
                updateCart(itemId, 1);
            } else if (quantityChangeBtn) {
                const itemId = quantityChangeBtn.dataset.itemId;
                const change = parseInt(quantityChangeBtn.dataset.change, 10);
                updateCart(itemId, change);
            }
        }

        function updateCart(itemId, change) {
            let item = cart[itemId];

            if (!item) {
                const menuItem = menuData.find(i => i.id === itemId);
                if (!menuItem) return;
                cart[itemId] = { ...menuItem, quantity: 0 };
                item = cart[itemId];
            }

            item.quantity += change;

            if (item.quantity <= 0) {
                delete cart[itemId];
            }
            
            renderCartUI();
            
            const buttonContainer = interactiveMenuItemsContainer.querySelector(`.order-button-container[data-item-id="${itemId}"]`);
            if (buttonContainer) {
                buttonContainer.innerHTML = getOrderItemHTML(itemId);
                lucide.createIcons();
            }
        }
        
        function renderCartUI() {
            const cartItemKeys = Object.keys(cart);
            cartItemsContainer.innerHTML = '';
            
            if (cartItemKeys.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500">Your cart is empty.</p>';
                cartButton.classList.add('hidden');
                cartTotalEl.textContent = '₹0.00';
                return;
            }

            let total = 0;
            cartItemKeys.forEach(key => {
                const item = cart[key];
                total += item.price * item.quantity;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between';
                itemEl.innerHTML = `
                     <div class="flex items-center gap-4">
                        <img src="${item.imageUrl || 'https://placehold.co/40x40'}" class="w-12 h-12 rounded object-cover">
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-xs text-gray-500">₹${item.price}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="cart-quantity-change-btn w-6 h-6 rounded bg-gray-200" data-item-id="${item.id}" data-change="-1">-</button>
                        <span>${item.quantity}</span>
                        <button class="cart-quantity-change-btn w-6 h-6 rounded bg-gray-200" data-item-id="${item.id}" data-change="1">+</button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemEl);
            });
            
            cartTotalEl.textContent = `₹${total.toFixed(2)}`;
            cartCountBadge.textContent = cartItemKeys.length;
            cartButton.classList.remove('hidden');
        }
        
        async function handleConfirmOrder() {
            const selectedRestaurantId = document.getElementById('order-restaurant-filter').value;
            if (Object.keys(cart).length === 0 || !selectedRestaurantId) {
                alert("Your cart is empty or no restaurant is selected.");
                return;
            }
            
            const orderItems = Object.values(cart).map(item => ({
                itemId: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity
            }));
            
            const total = orderItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

            const orderData = {
                restaurantId: selectedRestaurantId,
                userId: currentUserProfile.uid,
                items: orderItems,
                totalPrice: total.toFixed(2),
                notes: document.getElementById('chef-notes').value,
                status: 'Placed',
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, "orders"), orderData);
                alert("Order placed successfully!");
                listenToOrderStatus(docRef.id);
                cart = {};
                renderCartUI();
                renderInteractiveMenuItems(menuData.filter(item => item.restaurantId === selectedRestaurantId));
                cartPanel.classList.add('translate-x-full');
            } catch (error) {
                console.error("Error placing order:", error);
                alert("Could not place order. Please try again.");
            }
        }
        
        function handleEditOrder() {
            if (!currentActiveOrder) return;
            cart = {};
            currentActiveOrder.items.forEach(item => {
                const fullItem = menuData.find(m => m.id === item.itemId);
                if (fullItem) {
                    cart[item.itemId] = { ...fullItem, quantity: item.quantity };
                }
            });
            
            renderCartUI();
            cartPanel.classList.remove('translate-x-full');
            orderStatusFooter.classList.add('hidden');
            if (currentOrderUnsubscribe) {
                currentOrderUnsubscribe();
                currentOrderUnsubscribe = null;
            }
        }

        async function checkForActiveOrder(userId) {
            const q = query(
                collection(db, "orders"), 
                where("userId", "==", userId), 
                orderBy("createdAt", "desc"),
                limit(1)
            );
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const lastOrder = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                const nonTerminalStatus = !['Delivered', 'Cancelled'].includes(lastOrder.status);
                
                // Also check if order is recent (e.g., within last day)
                const oneDayAgo = new Date();
                oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                const orderDate = lastOrder.createdAt.toDate();

                if (nonTerminalStatus && orderDate > oneDayAgo) {
                    listenToOrderStatus(lastOrder.id);
                }
            }
        }

        function listenToOrderStatus(orderId) {
             if (currentOrderUnsubscribe) {
                currentOrderUnsubscribe();
            }
            currentOrderUnsubscribe = onSnapshot(doc(db, "orders", orderId), (doc) => {
                currentActiveOrder = { id: doc.id, ...doc.data() };
                if (currentActiveOrder && !['Delivered', 'Cancelled'].includes(currentActiveOrder.status)) {
                    orderStatusText.textContent = currentActiveOrder.status;
                    orderStatusFooter.classList.remove('hidden');

                    if(currentActiveOrder.status === 'Placed') {
                        editOrderBtn.classList.remove('hidden');
                    } else {
                        editOrderBtn.classList.add('hidden');
                    }
                } else {
                    orderStatusFooter.classList.add('hidden');
                    if (currentOrderUnsubscribe) {
                        currentOrderUnsubscribe();
                        currentOrderUnsubscribe = null;
                    }
                }
            });
        }

        // Initialize sorting functionality for all tables
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const table = header.closest('table');
                const sortKey = header.dataset.sortKey;
                const currentSort = header.classList.contains('asc') ? 'asc' : (header.classList.contains('desc') ? 'desc' : null);
                
                table.querySelectorAll('.sortable-header').forEach(h => h.classList.remove('asc', 'desc'));
                
                let direction = 'asc';
                if (currentSort === 'asc') {
                    direction = 'desc';
                    header.classList.add('desc');
                } else {
                    header.classList.add('asc');
                }
                
                sortTable(table.id, sortKey, direction);
            });
        });
        
        function sortTable(tableId, sortKey, direction) {
            let data;
            let renderFunction;

            if (tableId === 'restaurantTable') {
                data = restaurantData;
                renderFunction = renderRestaurantTable;
            } else if (tableId === 'userTable') {
                data = userData;
                renderFunction = renderUserTable;
            } else if (tableId === 'menuTable') {
                data = menuData;
                renderFunction = renderMenuTable;
            }

            data.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (sortKey === 'price' || sortKey === 'payment' || sortKey === 'prepTime') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderFunction();
        }
        
        // Checkbox functionality
        document.getElementById('select-all-menu-items').addEventListener('change', (e) => {
            document.querySelectorAll('.menu-item-checkbox').forEach(cb => cb.checked = e.target.checked);
            toggleDeleteButton();
        });
         document.getElementById('select-all-users').addEventListener('change', (e) => {
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = e.target.checked);
            toggleDeleteButton();
        });

        document.querySelector('#menuTable tbody').addEventListener('change', (e) => {
             if (e.target.classList.contains('menu-item-checkbox')) toggleDeleteButton();
        });
        document.querySelector('#userTable tbody').addEventListener('change', (e) => {
             if (e.target.classList.contains('user-checkbox')) toggleDeleteButton();
        });

        function toggleDeleteButton() {
             if (currentView === 'menu-content') {
                const anyChecked = document.querySelectorAll('.menu-item-checkbox:checked').length > 0;
                document.getElementById('delete-selected-menu-items-btn').classList.toggle('hidden', !anyChecked);
            } else if (currentView === 'user-management-content') {
                 const anyChecked = document.querySelectorAll('.user-checkbox:checked').length > 0;
                 document.getElementById('delete-selected-users-btn').classList.toggle('hidden', !anyChecked);
            }
        }

    </script>
</body>
</html>

